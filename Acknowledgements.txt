Many thanks to Jamie Brandon for ideas about lazy data structures.
